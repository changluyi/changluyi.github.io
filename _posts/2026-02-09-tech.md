---
layout: post
title: "技术分享 | HTTP/3：从根源到末梢的演进之路"
categories: 技术分享
tags: [HTTP3, QUIC, 网络协议, Cloudflare, 拥塞控制, 0-RTT, TLS13]
---

## 背景

最近在处理 CoreDNS 的 CVE，需要升级到 1.14.0。翻了下 Release Notes，发现一个有意思的变化：**DoH3 支持，添加 DNS over HTTP/3 的初步支持**。

DNS 走 HTTP？这让我有点意外。DNS 不是应该走 UDP 吗，怎么和 HTTP 扯上关系了？

了解之后才知道，DNS over HTTPS（DoH）在 2018 年就标准化了（RFC 8484）。为什么要把 DNS 包在 HTTP 里？

从性能角度来说，UDP DNS 其实更快——无需握手，直接发包。DoH 需要 TCP + TLS 握手，多了几轮 RTT，延迟明显更高。

所以 DoH 的价值不在性能，而是加密。

而 DoH3 利用 HTTP/3 的 0-RTT 特性，可以在一定程度上弥补 DoH 的性能损失。

HTTP/3 是 HTTP 协议的最新版本，标志着 Web 协议三十年演进的又一个里程碑。它基于 Cloudflare 的技术实践和 IETF 标准化工作，从根本上解决了 TCP 时代遗留的性能瓶颈。

## HTTP 协议的演进

### 早期岁月：HTTP/0.9 到 HTTP/1.1

| 版本 | 时间 | 主要特点 |
|------|------|----------|
| HTTP/0.9 | 1991年 | 极其简单的协议，仅支持 GET 方法 |
| HTTP/1.0 | 1996年 (RFC 1945) | 定义了基本的文本格式，每个请求创建新 TCP 连接 |
| HTTP/1.1 | 1997年 (RFC 2068) → 1999年 (RFC 2616) | 引入"保持活跃"连接概念，允许 TCP 连接复用 |

**HTTP/1.0 的局限：**
- 每个请求都需要新的 TCP 连接
- 每次都需完成 TCP 和 TLS 握手
- TCP 的"慢启动"机制限制初始带宽利用

**HTTP/1.1 的改进：**
- 引入连接复用（Keep-Alive）
- 但请求必须串行执行，同一时刻只能有一个请求/响应交换

### HTTP/2 时代（2015年）

随着 Web 资源数量（CSS、JavaScript、图片等）的增加，浏览器需要更高的并发能力。HTTP/2 通过以下改进解决了部分问题：

| 特性 | 说明 |
|------|------|
| **流（Streams）** | 允许在同一 TCP 连接上并发复用多个 HTTP 交换 |
| **二进制格式** | 从文本格式转为二进制，更高效解析 |
| **头部压缩（HPACK）** | 减少传输开销 |

**但 HTTP/2 仍有关键问题：队头阻塞（Head-of-Line Blocking）**

虽然 HTTP/2 层面可以分离不同的流，但 TCP 层面无法识别这些抽象。当单个数据包丢失时，整个 TCP 连接的所有流都会被延迟，即使其他流的数据已成功接收。

## HTTP/3 的诞生

### SPDY 实验（Google）

2009-2010年间，Google 开始实验 SPDY 协议：
- 保持 HTTP 语义不变
- 将语法从文本改为二进制
- 为后续 HTTP/2 奠定基础

### gQUIC 的出现（2012年）

Google 继续实验，开发了 gQUIC，做出了一个关键决策：**从 TCP 转向 UDP**。这个选择奠定了 HTTP/3 的技术基础。gQUIC 使用 SPDY v3 的 HTTP 语法，引入了 0-RTT（零往返时间）握手机制。

### IETF 标准化进程

**关键时间线：**

| 时间 | 事件 |
|------|------|
| 2015年6月 | draft-tsvwg-quic-protocol-00 提交到 IETF |
| 2015年7月 | IETF 93 Prague BoF 会议 |
| 2016年 | 新的一组 I-D 提交，明确 QUIC 与 HTTP 解耦 |
| 2016年 | IETF 96 Berlin 会议，QUIC 被正式采纳 |
| 2018年10月 | draft-ietf-quic-http-17 提出 |
| 2018年11月 | IETF 103 Bangkok 会议，达成将 "HTTP over QUIC" 改名为 HTTP/3 的共识 |

**为什么改名为 HTTP/3？**

1. "HTTP over QUIC" 名称无法体现与 HTTP/2 的不兼容性
2. 遵循 HTTP/2 的命名惯例："HTTP/2.0 仅意味着线格式与 HTTP/1.x 不兼容"
3. 减少社区混淆，便于沟通和互操作性

### HTTP/3 的核心改进

HTTP/3 将 HTTP 语义与 QUIC 传输层结合，从根本上解决了队头阻塞问题。与 HTTP/2 不同，QUIC 的流是独立交付的——单个包丢失只会影响那个流，不会阻塞其他流。

其他关键改进包括：连接建立更快（合并 TCP 和 TLS 握手）、用户空间实现（不依赖操作系统更新）、以及支持连接迁移（在不同网络间无缝切换）。

### 与 HTTP/2 的主要差异

| 特性 | HTTP/2 | HTTP/3 |
|------|--------|--------|
| 传输层 | TCP | QUIC (UDP) |
| 头部压缩 | HPACK | QPACK（修复 QUIC 无序交付问题） |
| 流控制 | HTTP 层面实现 | QUIC 层面内置 |
| 队头阻塞 | 存在 | 已解决 |
| 0-RTT | 需 TLS 1.3 | QUIC 内置支持 |

## Cloudflare 的 HTTP/3 实践

### quiche 开源项目

Cloudflare 用 Rust 编写了 QUIC 和 HTTP/3 的开源实现——[quiche](https://github.com/cloudflare/quiche)。这个库可以用于实现 HTTP/3 客户端和服务器，也支持纯 QUIC 场景。

### 行业合作推展

Cloudflare 与行业领袖紧密合作，共同推展 HTTP/3 的广泛应用：

| 合作方 | 角色 |
|--------|------|
| **Google Chrome** | 浏览器支持，协议验证 |
| **Mozilla Firefox** | 浏览器支持，互操作性测试 |
| **curl** | 命令行工具支持 |

> "HTTP/3 should make the web better for everyone. Strong partnership between industry leaders is what makes Internet standards innovations possible."
> —— Ryan Hamilton, Staff Software Engineer at Google

### 启用 HTTP/3

对于 Cloudflare 用户：
1. 在控制台的 "Network" 选项卡中启用 HTTP/3
2. 启用后，访客可通过支持 HTTP/3 的浏览器访稽您的网站

## HTTP/3 的未来

### 连接迁移

QUIC 允许连接在不同网络间无缝迁移——比如从家里的 WiFi 切换到移动网络时，无需重新建立连接。这是通过连接 ID 实现的：QUIC 连接不绑定到四元组（源/目的 IP + 端口），而是使用独立的连接 ID 标识。

### 零 RTT 恢复

类似于 TLS 1.3，QUIC 支持客户端在连接握手完成前就开始发送 HTTP 请求，进一步降低延迟。

### 持续演进

IETF QUIC 工作组持续改进协议规范，Cloudflare 承诺及时更新实现以配合标准演进。

## QUIC 关键技术特性

QUIC 传输协议不仅解决了 TCP 的队头阻塞问题，还引入了一系列创新机制来优化网络性能和安全性。

### 拥塞控制

QUIC 的拥塞控制机制继承自 TCP，但针对现代网络环境进行了优化。

#### CUBIC 拥塞控制算法

CUBIC 是专为高带宽延迟积（BDP）网络设计的拥塞控制算法，Cloudflare 的 quiche 实现已完整支持。与传统 TCP Reno 的线性增长不同，CUBIC 使用凹函数窗口增长，在高带宽环境下表现更优异，同时在常规网络中也能与现有 TCP 实现友好共存。

#### HyStart++ 慢启动优化

传统 TCP 慢启动面临一个难题：难以判断何时退出慢启动阶段。过早退出会浪费带宽，过晚退出则会导致大量丢包。

HyStart++ 通过在训练阶段收集 RTT 样本，检测 RTT 增加和包间隔变化等拥塞信号，从而找到更合适的退出点。Cloudflare 的测试表明，这项改进在常见网络场景下能提升吞吐量并减少重传。

### 丢包检测

QUIC 采用基于 RFC 9002 的丢包检测机制，比传统 TCP 更精细和高效。

#### 检测机制

QUIC 使用三种互补的检测机制：包阈值检测（快速识别突发丢包）、时间阈值检测（处理长尾延迟）、以及 PTO（Persistent Timeout，检测网络中断或严重拥塞）。这种多机制协作的方式比传统 TCP 的超时重传更加精确。

QUIC 还引入了"持久拥塞"的概念——当网络持续不可达导致多个包丢失时，会触发拥塞事件并降低发送窗口，这与传统 TCP 的处理逻辑类似但更精细。

### 0-RTT 连接恢复

QUIC 的 0-RTT 机制允许客户端在连接建立前就开始发送数据，大幅降低延迟。原理很简单：首次连接时，服务器会返回一个 session ticket；后续连接时，客户端可以在发送 Initial 包的同时携带应用数据，无需等待握手完成。

#### 安全考虑

0-RTT 机制需要谨慎处理以防范重放攻击：

**安全措施：**

| 措施 | 说明 |
|------|------|
| **单次使用令牌** | 每个 ticket 只能使用一次 |
| **过期机制** | ticket 有明确的有效期 |
| **有限的数据量** | 0-RTT 数据包大小受限 |
| **关键路径验证** | 敏感操作仍需完整握手 |

**Cloudflare 的实现：**
- 支持主动发送 session tickets
- 支持 NewSessionTicket 帧更新
- 前向安全性保障

### TLS 1.3 集成与安全

QUIC 深度集成 TLS 1.3，所有数据包都经过 AEAD（带关联数据的认证加密）保护。加密分为两层：头部保护（隐藏包类型和包编号）和载荷保护（加密实际数据）。这种设计使得即使是数据包的元信息也无法被中间设备窥探。

#### 加密算法与密钥派生

QUIC 支持 AES-128-GCM、AES-256-GCM 和 ChaCha20-Poly1305 等 AEAD 算法。密钥派生分为三个阶段：初始密钥（用于握手前的 Initial 包）、握手密钥（用于握手过程）、应用密钥（用于数据传输）。这种分层设计确保了前向安全性——即使某个阶段的密钥泄露，也不会影响其他阶段。

#### 头部保护机制

QUIC 的头部保护确保即使是数据包头部信息也无法被窥探：

**保护内容：**
- 包类型（Short/Long Header）
- 包编号
- 数据包长度

**未保护内容（明文）：**
- 版本号
- 目标连接 ID（用于路由）

### 与 TCP/TLS 的性能对比

基于 Fastly 和社区的测试数据：

#### 连接建立时间

| 协议栈 | 首次连接 RTT | 后续连接 RTT |
|--------|---------------|---------------|
| TCP + TLS 1.2 | 3 RTT | 2 RTT |
| TCP + TLS 1.3 | 2 RTT | 1 RTT |
| QUIC (内置 TLS 1.3) | 1 RTT | 0 RTT (resumption) |

#### 计算效率

**QUIC 的计算开销考虑：**

| 方面 | TCP/TLS | QUIC |
|------|----------|------|
| 用户空间实现 | ❌ 内核实现 | ✅ 用户空间，易于优化 |
| 系统调用开销 | 高（每个包） | 低（批量处理） |
| 加密硬件加速 | ✅ 可用 | ✅ 可用 |
| 多核并行 | ❌ 受限 | ✅ 易于并行 |

**实际测试结论：**
- 在现代硬件上，QUIC 的计算效率与 TCP/TLS 相当
- 用户空间实现提供了更多优化空间
- QUIC 的性能优势主要来自协议设计（HOL 消除、0-RTT）

## 技术总结

### HTTP/3 协议栈

从上到下：HTTP 语义层 → QPACK 头部压缩 → HTTP/3 映射层 → QUIC 传输层（流、流量控制、连接迁移、0-RTT）→ UDP

### 关键时间线

- 1991年：HTTP/0.9 诞生
- 1996年：HTTP/1.0 (RFC 1945)
- 1997年：HTTP/1.1 (RFC 2068)
- 1999年：HTTP/1.1 (RFC 2616) - Keep-Alive 时代
- 2009年：Google SPDY v1 公布
- 2012年：gQUIC 初始规范
- 2015年：HTTP/2 (RFC 7540) 正式发布
- 2016年：IETF 采用 QUIC 标准化
- 2018年：TLS 1.3 (RFC 8446)
- 2019年：HTTP/3 命名确定，Cloudflare 宣布支持

## 小结

HTTP/3 的演进之路体现了互联网标准的生命力：从实验到标准，从社区共识到广泛部署。HTTP/3 的广泛应用将为我们带来一个更快、更可靠、更安全的 Web 体验。

## 参考资源

- [HTTP/3: From root to tip - Cloudflare Blog](https://blog.cloudflare.com/http-3-from-root-to-tip/)
- [HTTP/3: The past, present, and future - Cloudflare Blog](https://blog.cloudflare.com/http3-the-past-present-and-future/)
- [CUBIC and HyStart++ Support in quiche](https://blog.cloudflare.com/cubic-and-hystart-support-in-quiche/)
- [QUIC 0-RTT resumption](https://blog.cloudflare.com/even-faster-connection-establishment-with-quic-0-rtt-resumption/)
- [Measuring QUIC vs TCP computational efficiency - Fastly](https://www.fastly.com/blog/measuring-quic-vs-tcp-computational-efficiency)
- **RFC**: 9000 (QUIC Transport), 9001 (QUIC TLS), 9002 (Loss Detection), 9114 (HTTP/3)
- **quiche**: https://github.com/cloudflare/quiche
